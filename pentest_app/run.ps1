Set-StrictMode -Version Latest
$ErrorActionPreference = 'Stop'

# Go to repo root
Set-Location -Path $PSScriptRoot

Write-Host "[+] Checking Python venv..."
if (-not (Test-Path .venv)) {
  Write-Host "[+] Creating virtual environment (.venv)"
  python -m venv .venv
}

Write-Host "[+] Activating venv"
. .\.venv\Scripts\Activate.ps1

Write-Host "[+] Upgrading pip & installing requirements"
python -m pip install --upgrade pip setuptools wheel
if (Test-Path requirements.txt) {
  pip install -r requirements.txt
}

# Load environment variables from .env if present
if (Test-Path .env) {
  Write-Host "[+] Loading environment from .env"
  Get-Content .env | ForEach-Object {
    $line = $_.Trim()
    if ($line -and -not $line.StartsWith('#') -and $line.Contains('=')) {
      $idx = $line.IndexOf('=')
      $key = $line.Substring(0, $idx)
      $val = $line.Substring($idx + 1)
      [System.Environment]::SetEnvironmentVariable($key, $val, 'Process') | Out-Null
    }
  }
}

Write-Host "[+] Starting GUI server (Flask-SocketIO)"
python pentest_app_gui\app.py
