# Scan de port avec scapy et nmap
import subprocess
from scapy.all import IP, TCP, sr1

def scan_ports(target, ports, use_nmap=False, progress_callback=None, should_stop=None):
    def log(msg):
        if progress_callback:
            progress_callback(msg)
        else:
            print(msg)
    if use_nmap:
        if should_stop and should_stop():
            log("Scan annulé.")
            return
        log(f"Scan de ports avec nmap sur {target}...")
        ports_str = ','.join(str(p) for p in ports)
        try:
            result = subprocess.run(["nmap", "-p", ports_str, target], capture_output=True, text=True)
            log(result.stdout)
        except Exception as e:
            log(f"Erreur lors de l'exécution de nmap : {e}")
    else:
        log(f"Scan de ports avec scapy sur {target}...")
        for port in ports:
            if should_stop and should_stop():
                log("Scan annulé.")
                break
            pkt = IP(dst=target)/TCP(dport=port,flags="S")
            resp = sr1(pkt, timeout=1, verbose=0)
            if resp and resp.haslayer(TCP) and resp[TCP].flags == 0x12:
                log(f"Port {port} ouvert")
            else:
                log(f"Port {port} fermé ou filtré")
