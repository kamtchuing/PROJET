import subprocess
from scapy.all import IP, ICMP, sr1

def scan_icmp(target, use_nmap=False, progress_callback=None):
    def log(msg):
        if progress_callback:
            progress_callback(msg)
        else:
            print(msg)
    if use_nmap:
        log(f"Scan ICMP avec nmap sur {target}...")
        try:
            result = subprocess.run(["nmap", "-sn", target], capture_output=True, text=True)
            for line in result.stdout.splitlines():
                log(line)
        except Exception as e:
            log(f"Erreur lors de l'exécution de nmap : {e}")
    else:
        log(f"Scan ICMP avec scapy sur {target}...")
        pkt = IP(dst=target)/ICMP()
        resp = sr1(pkt, timeout=2, verbose=0)
        if resp:
            log(f"{target} est en ligne !")
        else:
            log(f"{target} est hors ligne ou ne répond pas.")
